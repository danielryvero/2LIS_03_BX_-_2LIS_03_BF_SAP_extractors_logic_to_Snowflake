{{ config(materialized="incremental", 
    unique_key=["material_doc_num", "material_doc_year", "doc_item"], 
    pre_hook=["{{warehouse_size('MEDIUM')}}"],
    tags=["analyticsinventory"]) }}
with
    fact_goods_movement as (
        select
            material_doc_num,
            material_doc_year,
            doc_item,
            material_key,
            plant_key,
            storage_location_key,
            movement_type_key,
            posting_date,
            user_name,
            reference_doc_number,
            reference_doc_number_mkpf,
            quantity,
            entry_unit_key,
            recv_issue_plant_key,
            amount_lc,
            debit_credit_ind,
            transaction_event_type_key,
            accounting_doc_type_key,
            revaluation_doc_type_key,
            accounting_doc_entry_date,
            entry_time,
            last_changed_on,
            document_header_text,
            gr_gi_slip_version,
            gr_gi_slip_number,
            logical_system,
            transaction_code,
            external_wms_posting,
            goods_issue_time,
            delivery_number,
            line_id,
            parent_id,
            auto_item,
            batch_number,
            vendor_key,
            customer_key,
            currency_code_name,
            debit_credit_reval_ind,
            valuation_type,
            transaction_quantity,
            base_unit_key,
            qty_price_unit,
            order_price_unit_key,
            po_doc_number,
            po_doc_item,
            ref_doc_year,
            document_no_ref_doc_num,
            reference_doc_item_num,
            sec_doc_year,
            sec_doc_num,
            sec_doc_item,
            deliv_complete_ind,
            item_text,
            goods_recipient,
            co_area,
            cost_center_key,
            old_project_num,
            coorder_key,
            fiscal_year,
            allow_backpost,
            company_code,
            res_num,
            res_item_num,
            trans_event_stat,
            recv_issue_mat_key,
            recv_issue_storage_key,
            recv_issue_batch,
            transfer_batch_type,
            move_ind,
            special_stock_ind,
            mvnt_type_eval_key,
            consump_posting,
            receipt_ind,
            warehouse_number_key,
            storage_type_key,
            storage_bin_key,
            warehouse_movement_type_key,
            transfer_req_num,
            transfer_req_item,
            whs_posting_ind,
            src_interim_posting,
            dest_interim_posting,
            dyn_storage_bin,
            gr_gi_slips_num,
            movement_reason_key,
            profit_center_key,
            order_item,
            gl_account_key,
            po_unit,
            supplier,
            shelf_life_date,
            partner_profit_center,
            stock_material,
            recv_issue_mat_2,
            post_str_qty,
            post_str_val,
            qty_update,
            val_update,
            pre_post_stock,
            price_ctrl_ind,
            settle_ref_date,
            settle_ref_date_2,
            orig_doc_line,
            manufacture_date,
            stock_type_mod,
            stock_type_mod_description,
            trans_event_type_mkpf,
            posting_date_mkpf,
            entry_date_mkpf,
            entry_time_mkpf,
            user_name_mkpf,
            trans_code_mkpf,
            delivery_num,
            delivery_item,
            edw_load_timestamp,
            current_timestamp() as dbt_run_timestamp,
            datasource_key
        from {{ ref("trn_tbl_goods_movement") }}
    )
select
    material_doc_num,
    material_doc_year,
    doc_item,
    material_key,
    plant_key,
    storage_location_key,
    movement_type_key,
    posting_date,
    user_name,
    reference_doc_number,
    reference_doc_number_mkpf,
    quantity,
    entry_unit_key,
    recv_issue_plant_key,
    amount_lc,
    debit_credit_ind,
    transaction_event_type_key,
    accounting_doc_type_key,
    revaluation_doc_type_key,
    accounting_doc_entry_date,
    entry_time,
    last_changed_on,
    document_header_text,
    gr_gi_slip_version,
    gr_gi_slip_number,
    logical_system,
    transaction_code,
    external_wms_posting,
    goods_issue_time,
    delivery_number,
    line_id,
    parent_id,
    auto_item,
    batch_number,
    vendor_key,
    customer_key,
    currency_code_name,
    debit_credit_reval_ind,
    valuation_type,
    transaction_quantity,
    base_unit_key,
    qty_price_unit,
    order_price_unit_key,
    po_doc_number,
    po_doc_item,
    ref_doc_year,
    document_no_ref_doc_num,
    reference_doc_item_num,
    sec_doc_year,
    sec_doc_num,
    sec_doc_item,
    deliv_complete_ind,
    item_text,
    goods_recipient,
    co_area,
    cost_center_key,
    old_project_num,
    coorder_key,
    fiscal_year,
    allow_backpost,
    company_code,
    res_num,
    res_item_num,
    trans_event_stat,
    recv_issue_mat_key,
    recv_issue_storage_key,
    recv_issue_batch,
    transfer_batch_type,
    move_ind,
    special_stock_ind,
    mvnt_type_eval_key,
    consump_posting,
    receipt_ind,
    warehouse_number_key,
    storage_type_key,
    storage_bin_key,
    warehouse_movement_type_key,
    transfer_req_num,
    transfer_req_item,
    whs_posting_ind,
    src_interim_posting,
    dest_interim_posting,
    dyn_storage_bin,
    gr_gi_slips_num,
    movement_reason_key,
    profit_center_key,
    order_item,
    gl_account_key,
    po_unit,
    supplier,
    shelf_life_date,
    partner_profit_center,
    stock_material,
    recv_issue_mat_2,
    post_str_qty,
    post_str_val,
    qty_update,
    val_update,
    pre_post_stock,
    price_ctrl_ind,
    settle_ref_date,
    settle_ref_date_2,
    orig_doc_line,
    manufacture_date,
    stock_type_mod,
    stock_type_mod_description,
    trans_event_type_mkpf,
    posting_date_mkpf,
    entry_date_mkpf,
    entry_time_mkpf,
    user_name_mkpf,
    trans_code_mkpf,
    delivery_num,
    delivery_item,
    edw_load_timestamp,
    dbt_run_timestamp,
    datasource_key
from fact_goods_movement
{% if is_incremental() %}
    where
        edw_load_timestamp > (
            select ifnull(max(edw_load_timestamp), to_timestamp('1999-12-31 00:00:00'))
            from {{ this }}
        )
{% endif %}
